name: é‡æ–°æ„å»º Hugging Face ç©ºé—´
on:
  workflow_dispatch:
  schedule:
    - cron: '0 19 * * *'  # æ¯å¤©UTC 20:00 (åŒ—äº¬æ—¶é—´å‡Œæ™¨3:00)
env:
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  USERNAME: ${{ secrets.USERNAME }} # å¯ä»¥é€‰æ‹©å°†USERNAMEä¹Ÿæ”¾åˆ°secrets
  TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
  TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}  # å¯ä»¥é€‰æ‹©å°†TG_CHAT_IDä¹Ÿæ”¾åˆ°secrets
jobs:
  rebuild:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v2
      - name: é…ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'
      - name: å®‰è£…ä¾èµ–åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install requests
      - name: é‡æ–°æ„å»ºç©ºé—´
        id: rebuild
        run: |
          python <<EOF
          import requests
          import time
          import os
          
          # åŸºç¡€é…ç½®
          HF_TOKEN = os.environ['HF_TOKEN']
          USERNAME = os.environ['USERNAME']
          
          # å®šä¹‰éœ€è¦é‡æ–°æ„å»ºçš„ç©ºé—´åˆ—è¡¨
          SPACE_LIST = [
              "open-webui"
          ]
          
          def rebuild_space(space_name):
              """é‡æ–°æ„å»ºå•ä¸ªç©ºé—´çš„å‡½æ•°"""
              full_space_name = f"{USERNAME}/{space_name}"
              print(f"\n{'='*50}")
              print(f"ğŸ”„ å¼€å§‹é‡æ–°æ„å»ºç©ºé—´ï¼š{full_space_name}")
              
              # API æ¥å£
              rebuild_url = f"https://huggingface.co/api/spaces/{full_space_name}/restart?factory=true"
              status_url = f"https://huggingface.co/api/spaces/{full_space_name}/runtime"
              
              # è¯·æ±‚å¤´
              headers = {
                  "Authorization": f"Bearer {HF_TOKEN}",
                  "Content-Type": "application/json"
              }
              
              try:
                  # å‘é€é‡æ–°æ„å»ºè¯·æ±‚
                  response = requests.post(rebuild_url, headers=headers)
                  
                  if response.status_code == 200:
                      print(f"âœ… é‡æ–°æ„å»ºè¯·æ±‚å·²å‘é€æˆåŠŸ")
                      
                      # æ£€æŸ¥é‡æ–°æ„å»ºçŠ¶æ€
                      max_attempts = 10  # æœ€å¤§æ£€æŸ¥æ¬¡æ•°
                      for attempt in range(max_attempts):
                          print(f"â³ ç­‰å¾…30ç§’åæ£€æŸ¥çŠ¶æ€... (å°è¯• {attempt + 1}/{max_attempts})")
                          time.sleep(30)
                          
                          try:
                              status_response = requests.get(status_url, headers=headers)
                              if status_response.status_code == 200:
                                  status_data = status_response.json()
                                  stage = status_data.get("stage", "")
                                  print(f"å½“å‰çŠ¶æ€: {stage}")
                                  
                                  if stage == "RUNNING":
                                      print(f"âœ… ç©ºé—´ {space_name} å·²æˆåŠŸé‡æ–°æ„å»º!")
                                      return True
                                  elif stage == "RUNNING_BUILDING":
                                      print("ğŸ—ï¸ ç©ºé—´æ­£åœ¨æ„å»ºä¸­...")
                                  elif "ERROR" in stage:
                                      print(f"âŒ æ£€æµ‹åˆ°é”™è¯¯: {stage}")
                                      return False
                              else:
                                  print(f"âš ï¸ è·å–çŠ¶æ€å¤±è´¥ï¼ŒçŠ¶æ€ç : {status_response.status_code}")
                          except requests.RequestException as e:
                              print(f"âš ï¸ è¯·æ±‚å¼‚å¸¸: {str(e)}")
                      
                      print("âš ï¸ è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œé‡æ–°æ„å»ºçŠ¶æ€æœªçŸ¥")
                      return None
                  
                  else:
                      print(f"âŒ é‡æ–°æ„å»ºè¯·æ±‚å¤±è´¥. çŠ¶æ€ç : {response.status_code}")
                      print(f"å“åº”å†…å®¹: {response.text}")
                      return False
                  
              except Exception as e:
                  print(f"âŒ å‘ç”Ÿé”™è¯¯: {str(e)}")
                  return False
          
          # ä¸»ç¨‹åºï¼šå¾ªç¯é‡æ–°æ„å»ºæ‰€æœ‰ç©ºé—´
          success_spaces = []
          failed_spaces = []
          unknown_spaces = []
          
          print(f"ğŸš€ å‡†å¤‡é‡æ–°æ„å»ºä»¥ä¸‹ç©ºé—´: {', '.join(SPACE_LIST)}")
          
          for space in SPACE_LIST:
              result = rebuild_space(space)
              if result is True:
                  success_spaces.append(space)
              elif result is False:
                  failed_spaces.append(space)
              else:
                  unknown_spaces.append(space)
          
          # æ ¼å¼åŒ–è¾“å‡º
          summary = f"æ€»è®¡ç©ºé—´æ•°: {len(SPACE_LIST)}\n"
          summary += f"æˆåŠŸæ•°é‡: {len(success_spaces)}\n"
          summary += f"å¤±è´¥æ•°é‡: {len(failed_spaces)}\n"
          summary += f"æœªçŸ¥çŠ¶æ€æ•°é‡: {len(unknown_spaces)}\n"
          summary += "---\nå…·ä½“ç»“æœ:\n"
          summary += "\n".join([f"âœ… {space} é‡æ–°æ„å»ºæˆåŠŸ" for space in success_spaces])
          summary += "\n".join([f"âŒ {space} é‡æ–°æ„å»ºå¤±è´¥" for space in failed_spaces])
          summary += "\n".join([f"â“ {space} é‡æ–°æ„å»ºçŠ¶æ€æœªçŸ¥" for space in unknown_spaces])
          
          print("\n" + "="*50)
          print("ğŸ“Š é‡æ–°æ„å»ºæ€»ç»“:")
          print(summary)
          
          # ä¿å­˜ç»“æœåˆ° GitHub Actions è¾“å‡º
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              print("summary<<EOF", file=f)
              print(summary, file=f)
              print("EOF", file=f)
              print(f"exit_code={1 if failed_spaces or unknown_spaces else 0}", file=f)
          
          if failed_spaces or unknown_spaces:
              exit(1)
          else:
              exit(0)
          EOF
      - name: å‘é€ Telegram é€šçŸ¥
        if: always()
        run: |
          SUMMARY="${{ steps.rebuild.outputs.summary }}"
          # ä½¿ç”¨ echo -e æ¥æ­£ç¡®è§£é‡Šè½¬ä¹‰å­—ç¬¦
          MESSAGE=$(echo -e "Hugging Face ç©ºé—´é‡æ–°æ„å»ºç»“æœï¼š\n${SUMMARY}")
          curl -s -X POST https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage \
               -d chat_id=${{ env.TG_CHAT_ID }} \
               -d text="$MESSAGE" \
               -d parse_mode=Markdown
      - name: æ£€æŸ¥é‡æ–°æ„å»ºç»“æœ
        if: always()
        run: |
          exit ${{ steps.rebuild.outputs.exit_code }}
      - name: å®ŒæˆçŠ¶æ€
        if: always()
        run: |
          echo "ğŸ é‡æ–°æ„å»ºæµç¨‹å·²å®Œæˆ"
