name: éƒ¨ç½²æˆ–é‡æ–°æ„å»º Hugging Face ç©ºé—´

on:
  push:
    branches:
      - dev
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'  # æ¯å¤© UTC 20:00 (åŒ—äº¬æ—¶é—´å‡Œæ™¨ 3:00)

env:
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  HF_USER: ${{ secrets.HF_USER }}
  HF_REPO: ${{ secrets.HF_REPO }}
  TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
  TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

jobs:
  check-secret:
    runs-on: ubuntu-latest
    outputs:
      token-set: ${{ steps.check-key.outputs.defined }}
    steps:
      - id: check-key
        env:
          HF_TOKEN: ${{ env.HF_TOKEN }}
        if: "${{ env.HF_TOKEN != '' }}"
        run: echo "defined=true" >> $GITHUB_OUTPUT

  deploy-or-rebuild:
    runs-on: ubuntu-latest
    needs: [check-secret]
    if: needs.check-secret.outputs.token-set == 'true'
    steps:
      - name: æ£€å‡ºå­˜å‚¨åº“
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: åˆ é™¤ Git å†å²è®°å½•
        run: rm -rf .git

      - name: å°† YAML æ·»åŠ åˆ° README.md ä¸­
        run: |
          echo "---" > temp_readme.md
          echo "title: Open WebUI" >> temp_readme.md
          echo "emoji: ğŸ³" >> temp_readme.md
          echo "colorFrom: purple" >> temp_readme.md
          echo "colorTo: gray" >> temp_readme.md
          echo "sdk: docker" >> temp_readme.md
          echo "app_port: 8080" >> temp_readme.md
          echo "---" >> temp_readme.md
          cat README.md >> temp_readme.md
          mv temp_readme.md README.md

      - name: é…ç½® Git
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests huggingface_hub

      - name: æ£€æŸ¥ç©ºé—´æ˜¯å¦å­˜åœ¨å¹¶æ‰§è¡Œç›¸åº”æ“ä½œ
        id: deploy-or-rebuild
        run: |
          python <<EOF
          import os
          import requests
          import time
          from huggingface_hub import HfApi

          # é…ç½®
          HF_TOKEN = os.environ['HF_TOKEN']
          USERNAME = os.environ['HF_USER']
          SPACE_NAME = os.environ['HF_REPO']

          # åˆå§‹åŒ– Hugging Face API
          api = HfApi(token=HF_TOKEN)

          # æ£€æŸ¥ç©ºé—´æ˜¯å¦å­˜åœ¨
          try:
              api.repo_info(f"{USERNAME}/{SPACE_NAME}", repo_type="space")
              space_exists = True
              print(f"ç©ºé—´ {SPACE_NAME} å·²å­˜åœ¨ï¼Œå°†æ‰§è¡Œé‡æ–°æ„å»ºæ“ä½œã€‚")
          except Exception as e:
              space_exists = False
              print(f"ç©ºé—´ {SPACE_NAME} ä¸å­˜åœ¨ï¼Œå°†æ‰§è¡Œéƒ¨ç½²æ“ä½œã€‚")

          # å¦‚æœç©ºé—´ä¸å­˜åœ¨ï¼Œåˆ›å»ºå¹¶éƒ¨ç½²
          if not space_exists:
              print(f"æ­£åœ¨åˆ›å»ºç©ºé—´ {SPACE_NAME}...")
              api.create_repo(
                  repo_id=f"{USERNAME}/{SPACE_NAME}",
                  repo_type="space",
                  space_sdk="docker",
                  space_hardware="cpu-basic",
                  private=False
              )
              print(f"ç©ºé—´ {SPACE_NAME} å·²æˆåŠŸåˆ›å»ºã€‚")

              # æ¨é€ä»£ç åˆ°ç©ºé—´
              print(f"æ­£åœ¨æ¨é€ä»£ç åˆ°ç©ºé—´ {SPACE_NAME}...")
              os.system("git init --initial-branch=main")
              os.system("git lfs install")
              os.system("git lfs track '*.ttf'")
              os.system("git lfs track '*.jpg'")
              os.system("git add .")
              os.system("git commit -m 'GitHub deploy: ${{ github.sha }}'")
              os.system(f"git push --force https://{USERNAME}:{HF_TOKEN}@huggingface.co/spaces/{USERNAME}/{SPACE_NAME} main")
              print(f"ä»£ç å·²æˆåŠŸæ¨é€åˆ°ç©ºé—´ {SPACE_NAME}ã€‚")

          # å¦‚æœç©ºé—´å­˜åœ¨ï¼Œé‡æ–°æ„å»º
          else:
              print(f"æ­£åœ¨é‡æ–°æ„å»ºç©ºé—´ {SPACE_NAME}...")
              def rebuild_space(space_name):
                  full_space_name = f"{USERNAME}/{space_name}"
                  print(f"\n{'='*50}")
                  print(f"ğŸ”„ å¼€å§‹é‡æ–°æ„å»ºç©ºé—´ï¼š{full_space_name}")

                  rebuild_url = f"https://huggingface.co/api/spaces/{full_space_name}/restart?factory=true"
                  status_url = f"https://huggingface.co/api/spaces/{full_space_name}/runtime"
                  headers = {
                      "Authorization": f"Bearer {HF_TOKEN}",
                      "Content-Type": "application/json"
                  }

                  try:
                      response = requests.post(rebuild_url, headers=headers)
                      if response.status_code == 200:
                          print(f"âœ… é‡æ–°æ„å»ºè¯·æ±‚å·²å‘é€æˆåŠŸ")
                          max_attempts = 10
                          for attempt in range(max_attempts):
                              print(f"â³ ç­‰å¾…30ç§’åæ£€æŸ¥çŠ¶æ€... (å°è¯• {attempt + 1}/{max_attempts})")
                              time.sleep(30)
                              status_response = requests.get(status_url, headers=headers)
                              if status_response.status_code == 200:
                                  status_data = status_response.json()
                                  stage = status_data.get("stage", "")
                                  print(f"å½“å‰çŠ¶æ€: {stage}")
                                  if stage == "RUNNING":
                                      print(f"âœ… ç©ºé—´ {space_name} å·²æˆåŠŸé‡æ–°æ„å»º!")
                                      return True
                                  elif stage == "RUNNING_BUILDING":
                                      print("ğŸ—ï¸ ç©ºé—´æ­£åœ¨æ„å»ºä¸­...")
                                  elif "ERROR" in stage:
                                      print(f"âŒ æ£€æµ‹åˆ°é”™è¯¯: {stage}")
                                      return False
                              else:
                                  print(f"âš ï¸ è·å–çŠ¶æ€å¤±è´¥ï¼ŒçŠ¶æ€ç : {status_response.status_code}")
                          print("âš ï¸ è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œé‡æ–°æ„å»ºçŠ¶æ€æœªçŸ¥")
                          return None
                      else:
                          print(f"âŒ é‡æ–°æ„å»ºè¯·æ±‚å¤±è´¥. çŠ¶æ€ç : {response.status_code}")
                          print(f"å“åº”å†…å®¹: {response.text}")
                          return False
                  except Exception as e:
                      print(f"âŒ å‘ç”Ÿé”™è¯¯: {str(e)}")
                      return False

              result = rebuild_space(SPACE_NAME)
              if result is True:
                  summary = f"âœ… ç©ºé—´ {SPACE_NAME} é‡æ–°æ„å»ºæˆåŠŸ"
                  exit_code = 0
              elif result is False:
                  summary = f"âŒ ç©ºé—´ {SPACE_NAME} é‡æ–°æ„å»ºå¤±è´¥"
                  exit_code = 1
              else:
                  summary = f"â“ ç©ºé—´ {SPACE_NAME} é‡æ–°æ„å»ºçŠ¶æ€æœªçŸ¥"
                  exit_code = 1

              # ä¿å­˜ç»“æœåˆ° GitHub Actions è¾“å‡º
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  print(f"summary={summary}", file=f)
                  print(f"exit_code={exit_code}", file=f)

              exit(exit_code)
          EOF

      - name: å‘é€ Telegram é€šçŸ¥
        if: always()
        run: |
          SUMMARY="${{ steps.deploy-or-rebuild.outputs.summary || 'ç©ºé—´éƒ¨ç½²æˆ–é‡æ–°æ„å»ºå·²å®Œæˆ' }}"
          MESSAGE=$(echo -e "Hugging Face ç©ºé—´æ“ä½œç»“æœï¼š\n${SUMMARY}")
          curl -s -X POST https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage \
               -d chat_id=${{ env.TG_CHAT_ID }} \
               -d text="$MESSAGE" \
               -d parse_mode=Markdown

      - name: æ£€æŸ¥æ“ä½œç»“æœ
        if: always()
        run: |
          exit ${{ steps.deploy-or-rebuild.outputs.exit_code || 0 }}

      - name: å®ŒæˆçŠ¶æ€
        if: always()
        run: |
          echo "ğŸ éƒ¨ç½²æˆ–é‡æ–°æ„å»ºæµç¨‹å·²å®Œæˆ"
